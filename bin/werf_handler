#!/bin/bash

### Remove ARGO_ENV_ prefix
for envVar in ${!ARGOCD_ENV_*}
do
  export ${envVar#ARGOCD_ENV_}=${!envVar}
done

### Get vault token
JWT=`cat /var/run/secrets/kubernetes.io/serviceaccount/token`
VAULT_TOKEN=`curl -s -k --request POST \
  --data '{"jwt": "'"${JWT}"'", "role": "'"${PROJECT}"'"}' \
  ${VAULT_ADDR}/v1/auth/${VAULT_AUTH_METHOD}/login | jq -r '.auth.client_token'`

### Get deploy secrets
SECRETS=`curl -s -H "X-Vault-Request: true" -H "X-Vault-Token: ${VAULT_TOKEN}" \
  ${VAULT_ADDR}/v1/${PROJECT}/data/infra/deploy/cd | jq -r '.data.data | to_entries | map(.key + "=" + .value) | .[]'`

### Set env vars from deploy secret
for row in $(echo "${SECRETS}"); do
  export $row
done

### Set env vars for werf
REGEX='^(https?|ssh):\/\/([a-zA-Z0-9\.\@\:\-]+)\/(.+).git$'

if [[ $ARGOCD_APP_SOURCE_REPO_URL =~ $REGEX ]]; then
  export WERF_REPO=${REGISTRY}/${PROJECT}/cache
  export WERF_FINAL_REPO=${REGISTRY}/${PROJECT}/${BASH_REMATCH[3]}
  export DOCKER_CONFIG=/tmp/${ARGOCD_APP_NAME}
else
  echo "Cannot parse git url!"; exit 1;
fi

### Script handler
if [[ $1 == "init" ]] && grep -q "image:" "werf.yaml"; then
  rm -f /tmp/${ARGOCD_APP_NAME}/config.json
  werf cr login ${REGISTRY}
elif [[ $1 == "render" ]]; then
  if [[ -z "${AVP_TYPE}" ]]; then
    werf render --set-docker-config-json-value
 else
    werf render --set-docker-config-json-value | argocd-vault-plugin generate -
  fi
fi
